version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: rutor
      POSTGRES_PASSWORD: rutorpass
      POSTGRES_DB: rutorbot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rutor -d rutorbot"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  bot:
    build: .
    restart: unless-stopped
    command: ["bot"]
    volumes:
      - film_cache:/app/data/film_cache
    environment:
      - RUTOR_BOT_DATABASE_URL=postgresql://rutor:rutorpass@postgres:5432/rutorbot
      - RUTOR_BOT_REDIS_URL=redis://redis:6379
      - RUTOR_BOT_TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - RUTOR_BOT_TORRENT_CLIENT=${TORRENT_CLIENT:-transmission}
      - RUTOR_BOT_TRANSMISSION_HOST=${TRANSMISSION_HOST:-localhost}
      - RUTOR_BOT_TRANSMISSION_PORT=${TRANSMISSION_PORT:-9091}
      - RUTOR_BOT_TRANSMISSION_USERNAME=${TRANSMISSION_USERNAME}
      - RUTOR_BOT_TRANSMISSION_PASSWORD=${TRANSMISSION_PASSWORD}
      - RUTOR_BOT_QBITTORRENT_HOST=${QBITTORRENT_HOST:-localhost}
      - RUTOR_BOT_QBITTORRENT_PORT=${QBITTORRENT_PORT:-8080}
      - RUTOR_BOT_QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME:-admin}
      - RUTOR_BOT_QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD:-adminadmin}
      - RUTOR_BOT_USERS_WHITE_LIST=${USERS_WHITE_LIST}
      - RUTOR_BOT_PROXY=${PROXY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  scheduler:
    build: .
    restart: unless-stopped
    command: ["scheduler"]
    volumes:
      - film_cache:/app/data/film_cache
    environment:
      - RUTOR_BOT_DATABASE_URL=postgresql://rutor:rutorpass@postgres:5432/rutorbot
      - RUTOR_BOT_REDIS_URL=redis://redis:6379
      - RUTOR_BOT_TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - RUTOR_BOT_TORRENT_CLIENT=${TORRENT_CLIENT:-transmission}
      - RUTOR_BOT_TRANSMISSION_HOST=${TRANSMISSION_HOST:-localhost}
      - RUTOR_BOT_TRANSMISSION_PORT=${TRANSMISSION_PORT:-9091}
      - RUTOR_BOT_TRANSMISSION_USERNAME=${TRANSMISSION_USERNAME}
      - RUTOR_BOT_TRANSMISSION_PASSWORD=${TRANSMISSION_PASSWORD}
      - RUTOR_BOT_QBITTORRENT_HOST=${QBITTORRENT_HOST:-localhost}
      - RUTOR_BOT_QBITTORRENT_PORT=${QBITTORRENT_PORT:-8080}
      - RUTOR_BOT_QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME:-admin}
      - RUTOR_BOT_QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD:-adminadmin}
      - RUTOR_BOT_USERS_WHITE_LIST=${USERS_WHITE_LIST}
      - RUTOR_BOT_PROXY=${PROXY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    build: .
    restart: unless-stopped
    command: ["worker"]
    volumes:
      - film_cache:/app/data/film_cache
    environment:
      - RUTOR_BOT_DATABASE_URL=postgresql://rutor:rutorpass@postgres:5432/rutorbot
      - RUTOR_BOT_REDIS_URL=redis://redis:6379
      - RUTOR_BOT_TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      - RUTOR_BOT_TORRENT_CLIENT=${TORRENT_CLIENT:-transmission}
      - RUTOR_BOT_TRANSMISSION_HOST=${TRANSMISSION_HOST:-localhost}
      - RUTOR_BOT_TRANSMISSION_PORT=${TRANSMISSION_PORT:-9091}
      - RUTOR_BOT_TRANSMISSION_USERNAME=${TRANSMISSION_USERNAME}
      - RUTOR_BOT_TRANSMISSION_PASSWORD=${TRANSMISSION_PASSWORD}
      - RUTOR_BOT_QBITTORRENT_HOST=${QBITTORRENT_HOST:-localhost}
      - RUTOR_BOT_QBITTORRENT_PORT=${QBITTORRENT_PORT:-8080}
      - RUTOR_BOT_QBITTORRENT_USERNAME=${QBITTORRENT_USERNAME:-admin}
      - RUTOR_BOT_QBITTORRENT_PASSWORD=${QBITTORRENT_PASSWORD:-adminadmin}
      - RUTOR_BOT_USERS_WHITE_LIST=${USERS_WHITE_LIST}
      - RUTOR_BOT_PROXY=${PROXY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    # You can scale workers if needed
    # docker-compose up --scale worker=3

  migrations:
    build: .
    command: ["alembic", "upgrade", "head"]
    environment:
      - RUTOR_BOT_DATABASE_URL=postgresql://rutor:rutorpass@postgres:5432/rutorbot
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  film_cache:
